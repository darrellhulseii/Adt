<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Way to Perfection - PS1 Style RPG</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; touch-action:manipulation; }
        body { background:#000; overflow:hidden; font-family:'Courier New',monospace; color:#fff; }
        #container { position:relative; width:100vw; height:100vh; }
        canvas { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); image-rendering:pixelated; background:#000; max-width:100vw; max-height:calc(100vh - 280px); }
        #controls { position:absolute; bottom:0; left:0; width:100%; height:280px; pointer-events:none; z-index:10; }
        .btn { position:absolute; background:rgba(255,255,255,0.15); border:3px solid rgba(255,255,255,0.5); border-radius:50%; pointer-events:all; user-select:none; transition:all 0.05s; }
        .btn:active { background:rgba(255,255,255,0.5); transform:scale(0.92); }
        .dpad { width:160px; height:160px; }
        .dpad div { position:absolute; background:rgba(0,0,0,0.6); }
        .dpad .up    { top:0; left:50px; width:60px; height:50px; border-radius:25px 25px 10px 10px; }
        .dpad .down  { bottom:0; left:50px; width:60px; height:50px; border-radius:10px 10px 25px 25px; }
        .dpad .left  { left:0; top:50px; width:50px; height:60px; border-radius:25px 10px 10px 25px; }
        .dpad .right { right:0; top:50px; width:50px; height:60px; border-radius:10px 25px 25px 10px; }
        .face { width:100px; height:100px; font-size:55px; line-height:100px; text-align:center; font-weight:bold; text-shadow:2px 2px 4px #000; }
        .shoulder { width:140px; height:70px; border-radius:35px; background:rgba(200,200,200,0.3); font-size:24px; line-height:70px; text-align:center; }
        .startselect { width:80px; height:45px; border-radius:25px; background:rgba(255,100,100,0.4); font-size:16px; line-height:45px; text-align:center; }
        #pause-btn { position:absolute; top:10px; left:10px; padding:10px 15px; background:#0056a0; color:#fff; border:none; border-radius:8px; font-size:14px; z-index:20; pointer-events:all; }
    </style>
</head>
<body>
    <div id="container">
        <canvas id="canvas" width="800" height="600"></canvas>
        <button id="pause-btn" onclick="togglePause()">⏸️ Menu</button>

        <div id="controls">
            <!-- D-Pad -->
            <div class="dpad btn" style="left:40px; bottom:70px;">
                <div class="up" id="up"></div>
                <div class="down" id="down"></div>
                <div class="left" id="left"></div>
                <div class="right" id="right"></div>
            </div>

            <!-- Face Buttons -->
            <div class="face btn" style="right:140px; bottom:160px;" id="triangle">△</div>
            <div class="face btn" style="right:70px;  bottom:230px;" id="circle">○</div>
            <div class="face btn" style="right:140px; bottom:300px;" id="cross">×</div>
            <div class="face btn" style="right:210px; bottom:230px;" id="square">□</div>

            <!-- Shoulders -->
            <div class="shoulder btn" style="left:100px; top:20px;" id="l1">L1</div>
            <div class="shoulder btn" style="left:250px; top:20px;" id="l2">L2</div>
            <div class="shoulder btn" style="right:250px; top:20px;" id="r1">R1</div>
            <div class="shoulder btn" style="right:100px; top:20px;" id="r2">R2</div>

            <!-- Start / Select -->
            <div class="startselect btn" style="left:50%; margin-left:-120px; bottom:40px;" id="select">Select</div>
            <div class="startselect btn" style="left:50%; margin-left:40px; bottom:40px;" id="start">Start</div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        ctx.imageSmoothingEnabled = false;

        const TILE_SIZE = 32;
        const WORLD_W = 60, WORLD_H = 60;

        // Intro with exact CCC quotes
        const introPages = [
            `Catechism of the Catholic Church §1849-1850:\n"Sin is an offense against reason, truth, and right conscience; it is failure in genuine love for God and neighbor caused by a perverse attachment to certain goods. It wounds the nature of man and injures human solidarity. It has been defined as 'an utterance, a deed, or a desire contrary to the eternal law.'"`,
            `CCC §1855:\n"Mortal sin destroys charity in the heart of man by a grave violation of God's law; it turns man away from God... Venial sin allows charity to subsist, even though it offends and wounds it."`,
            `Genesis 3: The Fall introduced sin and death through envy of the devil.\nRevelation 21 promises a new heaven and earth where sin and death are no more.`,
            `Your Quest:\nSeven towns are enslaved by the Seven Capital Sins.\nDefeat each boss to liberate the town and gain the opposing Virtue.\nConfess in the church for forgiveness and strength.\nFinal sin: Pride - Sephiroth.\nPress × to begin.`
        ];
        let introPage = 0;

        // Correct 7 Deadly Sins + Virtues + Saints
        const towns = [
            {name:'Envy City', sin:'Envy', virtue:'Kindness (Benignitas)', saint:'St. Philip Neri', npcs:['Superman','Batman','Wonder Woman'], boss:{name:'Legion', hp:400, atk:30}},
            {name:'Greed City', sin:'Greed (Avarice)', virtue:'Charity (Generosity)', saint:'St. Francis of Assisi', npcs:['Spider-Man','Iron Man','Captain America'], boss:{name:'Spoil', hp:500, atk:35}},
            {name:'Sloth City', sin:'Sloth (Acedia)', virtue:'Diligence', saint:'St. Joseph the Worker', npcs:['Optimus Prime','Megatron','Bumblebee'], boss:{name:'Indolence', hp:600, atk:38}},
            {name:'Gluttony City', sin:'Gluttony', virtue:'Temperance', saint:'St. Thomas Aquinas', npcs:['Sonic','Tails','Knuckles'], boss:{name:'The Devourer', hp:700, atk:42}},
            {name:'Lust City', sin:'Lust', virtue:'Chastity', saint:'St. Maria Goretti', npcs:['Pinhead','Cenobites'], boss:{name:'Cravings', hp:800, atk:48}},
            {name:'Wrath City', sin:'Wrath', virtue:'Patience (Meekness)', saint:'St. Stephen', npcs:['Edward Elric','Roy Mustang','Scar'], boss:{name:'Wrath', hp:900, atk:55}},
            {name:'Pride City', sin:'Pride', virtue:'Humility', saint:'St. John the Baptist', npcs:['Sephiroth (illusion)'], boss:{name:'Sephiroth', hp:1200, atk:70, quote:'I am the chosen one.'}}
        ];

        const townPos = [[10,5],[20,15],[30,25],[40,35],[50,45],[15,40],[45,10]];

        let map = Array.from({length:WORLD_H},()=>Array(WORLD_W).fill(0));
        function genMap() {
            for(let y=0;y<WORLD_H;y++) for(let x=0;x<WORLD_W;x++) {
                let base = y<15?3:y<30?4:0;
                map[y][x] = base;
                if(Math.random()<0.08) map[y][x]=1;
                if(Math.random()<0.05 + y/200) map[y][x]=2;
            }
            townPos.forEach((p,i)=>map[p[1]][p[0]]=6);
        }
        genMap();

        let player = {x:30,y:30,px:30*TILE_SIZE,py:30*TILE_SIZE,moving:false};

        const STATES = {INTRO:0,OVERWORLD:1,TOWN:2,CHURCH:3,CONFESSION:4,BATTLE:5,MENU:6,DIALOG:7,PAUSE:8,POSTGAME:9};
        let state = STATES.INTRO;
        let curTown = 0, confessionStep = 0, paused = false;

        // Party
        const partyBase = [
            {name:'Cloud',hp:200,mhp:200,mp:80,atk:40,def:30,spd:15,lvl:1,xp:0,next:100},
            {name:'Sora',hp:180,mhp:180,mp:100,atk:35,def:25,spd:20,lvl:1,xp:0,next:100},
            {name:'Terra',hp:170,mhp:170,mp:120,atk:32,def:35,spd:16,lvl:1,xp:0,next:100}
        ];
        let party = JSON.parse(JSON.stringify(partyBase));
        let active = [0,1,2];

        let virtues = 0;

        // Battle animation
        let battleAnim = {type:'', timer:0, dmg:0, x:0, y:0};

        // Input
        const input = {
            up:false,down:false,left:false,right:false,
            cross:false,circle:false,square:false,triangle:false,
            l1:false,l2:false,r1:false,r2:false,
            start:false,select:false
        };

        function hold(btn) { input[btn] = true; }
        function release(btn) { input[btn] = false; }

        document.querySelectorAll('#up,#down,#left,#right,#cross,#circle,#square,#triangle,#l1,#l2,#r1,#r2,#start,#select').forEach(el => {
            el.addEventListener('touchstart', e => { e.preventDefault(); hold(el.id); });
            el.addEventListener('touchend', () => release(el.id));
            el.addEventListener('mousedown', () => hold(el.id));
            el.addEventListener('mouseup', () => release(el.id));
            el.addEventListener('mouseleave', () => release(el.id));
        });

        function togglePause() { paused = !paused; }

        function gameLoop() {
            if (!paused) update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        function update() {
            if (state === STATES.INTRO && input.cross) {
                introPage++;
                if (introPage >= introPages.length) state = STATES.OVERWORLD;
            }

            if (state === STATES.OVERWORLD) {
                if (player.moving) return;
                let dx=0, dy=0;
                if (input.left) dx=-1;
                if (input.right) dx=1;
                if (input.up) dy=-1;
                if (input.down) dy=1;
                if (dx||dy) movePlayer(dx,dy);
                if (input.triangle) state = STATES.MENU;
            }

            if (state === STATES.TOWN) {
                if (input.cross) {
                    if (Math.random()<0.5) state = STATES.CHURCH;
                    else startBattle(towns[curTown].boss);
                }
                if (input.circle) state = STATES.OVERWORLD;
            }

            if (state === STATES.CHURCH) {
                if (input.cross) state = STATES.CONFESSION;
                if (input.circle) state = STATES.TOWN;
            }

            if (state === STATES.CONFESSION) {
                if (input.cross) {
                    confessionStep++;
                    if (confessionStep >= confessionSteps.length) {
                        state = STATES.DIALOG;
                        currentDialog = 'Absolution granted. Your soul is strengthened.';
                        confessionStep = 0;
                    }
                }
            }

            if (state === STATES.BATTLE) updateBattle();
        }

        function movePlayer(dx,dy) {
            let nx = player.x + dx, ny = player.y + dy;
            if (nx<0||nx>=WORLD_W||ny<0||ny>=WORLD_H||map[ny][nx]===1) return;
            player.moving = true;
            let tx = nx*TILE_SIZE, ty = ny*TILE_SIZE;
            let step = 6;
            let int = setInterval(() => {
                player.px += dx*step;
                player.py += dy*step;
                if (Math.abs(tx-player.px)<step && Math.abs(ty-player.py)<step) {
                    player.px = tx; player.py = ty;
                    player.x = nx; player.y = ny;
                    player.moving = false;
                    clearInterval(int);
                    if (map[ny][nx]===2 && Math.random()<0.4) startBattle({name:'Monster',hp:200,atk:25});
                    let tid = townPos.findIndex(p=>p[0]===nx&&p[1]===ny);
                    if (tid!==-1) { curTown=tid; state=STATES.TOWN; }
                }
            },16);
        }

        let enemies = [], playerTurn = true;
        function startBattle(boss) {
            state = STATES.BATTLE;
            enemies = [{...boss, curHp:boss.hp}];
            playerTurn = true;
            battleAnim = {type:'', timer:0};
        }

        function updateBattle() {
            if (battleAnim.timer > 0) {
                battleAnim.timer--;
                return;
            }

            if (playerTurn && input.cross) {
                let dmg = Math.max(10, party[active[0]].atk - enemies[0].atk/5);
                enemies[0].curHp -= dmg;
                battleAnim = {type:'slash', timer:40, dmg:dmg, x:500, y:200};
                playerTurn = false;
            }

            if (!playerTurn) {
                let dmg = Math.max(5, enemies[0].atk - party[active[0]].def/3);
                party[active[0]].hp -= dmg;
                battleAnim = {type:'hit', timer:40, dmg:dmg, x:100, y:300};
                playerTurn = true;
            }

            if (enemies[0].curHp <= 0) {
                virtues++;
                state = virtues===7 ? STATES.POSTGAME : STATES.TOWN;
            }
        }

        let currentDialog = '';
        const confessionSteps = [
            "Player: Bless me, Father, for I have sinned.",
            `CCC §1451: "Among the penitent's acts contrition occupies first place. Contrition is 'sorrow of the soul and detestation for the sin committed, together with the resolution not to sin again.'"`,
            "Player: I am sorry for these and all my sins.",
            "Priest: Your penance is to defeat the sin of this town.",
            "Player: Act of Contrition: O my God, I am heartily sorry...",
            "Priest: CCC §1468-1470: Through the ministry of the Church, God grants pardon. I absolve you in the name of the Father, and of the Son, and of the Holy Spirit. Amen."
        ];

        function draw() {
            ctx.fillStyle = '#000'; ctx.fillRect(0,0,800,600);

            if (state === STATES.INTRO) {
                ctx.fillStyle = '#fff';
                ctx.font = '20px Courier New';
                let lines = introPages[introPage].split('\n');
                lines.forEach((l,i) => ctx.fillText(l,100,150 + i*40));
                ctx.fillText('× Next',600,550);
            } else if ([STATES.OVERWORLD,STATES.TOWN].includes(state)) {
                let camX = player.px - 400, camY = player.py - 300;
                for(let y=0;y<19;y++) for(let x=0;x<25;x++) {
                    let tx = Math.floor((camX + x*TILE_SIZE)/TILE_SIZE);
                    let ty = Math.floor((camY + y*TILE_SIZE)/TILE_SIZE);
                    if(tx<0||tx>=WORLD_W||ty<0||ty>=WORLD_H) ctx.fillStyle='#111';
                    else {
                        let t = map[ty][tx];
                        ctx.fillStyle = t===0?'#228B22':t===1?'#006400':t===2?'#8B4513':t===3?'#F0F8FF':t===4?'#808080':t===6?'#FFD700':'#444';
                    }
                    ctx.fillRect(x*TILE_SIZE,y*TILE_SIZE,TILE_SIZE,TILE_SIZE);
                }
                // Player
                ctx.fillStyle = '#00BFFF';
                ctx.fillRect(player.px-camX+10,player.py-camY+5,20,30);
                ctx.fillStyle = '#FFD700';
                ctx.fillRect(player.px-camX+8,player.py-camY,24,15);

                if (state===STATES.TOWN) {
                    ctx.fillStyle = 'rgba(0,0,100,0.9)';
                    ctx.fillRect(150,150,500,300);
                    ctx.fillStyle = '#fff';
                    ctx.font = '28px Courier New';
                    ctx.fillText(towns[curTown].name,400,220);
                    ctx.font = '18px Courier New';
                    ctx.fillText(`Sin: ${towns[curTown].sin}`,250,280);
                    ctx.fillText(`Virtue: ${towns[curTown].virtue}`,250,320);
                    ctx.fillText('× Church / Boss',250,380);
                }
            } else if (state === STATES.CHURCH) {
                ctx.fillStyle = 'rgba(255,255,255,0.9)';
                ctx.fillRect(150,150,500,300);
                ctx.fillStyle = '#000';
                ctx.font = '24px Courier New';
                ctx.fillText(`${towns[curTown].saint}`,300,220);
                ctx.fillText('× Confess',300,320);
            } else if (state === STATES.CONFESSION) {
                ctx.fillStyle = 'rgba(240,248,255,0.95)';
                ctx.fillRect(100,100,600,400);
                ctx.fillStyle = '#000';
                ctx.font = '18px Courier New';
                let lines = confessionSteps[confessionStep].split('\n');
                lines.forEach((l,i) => ctx.fillText(l,120,180 + i*50));
                ctx.fillText('× Continue',350,450);
            } else if (state === STATES.BATTLE) {
                ctx.fillStyle = '#222';
                ctx.fillRect(0,0,800,600);

                // Enemy with animation
                ctx.fillStyle = '#f00';
                ctx.fillRect(450,150,300,300);
                if (battleAnim.type === 'slash' && battleAnim.timer > 0) {
                    ctx.strokeStyle = '#ff0';
                    ctx.lineWidth = 8;
                    ctx.beginPath();
                    ctx.moveTo(battleAnim.x, battleAnim.y);
                    ctx.lineTo(battleAnim.x + 200, battleAnim.y + 200);
                    ctx.stroke();
                    ctx.fillStyle = '#ff0';
                    ctx.font = '40px Courier New';
                    ctx.fillText('-' + battleAnim.dmg, battleAnim.x + 100, battleAnim.y + 100);
                }
                ctx.fillStyle = '#fff';
                ctx.font = '24px Courier New';
                ctx.fillText(enemies[0].name,500,120);
                ctx.fillText(`HP ${enemies[0].curHp}`,500,480);

                // Player party
                ctx.fillStyle = '#00f';
                ctx.fillRect(50,300,300,200);
                ctx.fillStyle = '#fff';
                ctx.fillText(party[active[0]].name,100,350);
                ctx.fillText(`HP ${party[active[0]].hp}`,100,400);
                if (battleAnim.type === 'hit' && battleAnim.timer > 0) {
                    ctx.fillStyle = '#f88';
                    ctx.fillRect(battleAnim.x, battleAnim.y, 100, 20);
                    ctx.fillStyle = '#fff';
                    ctx.fillText('-' + battleAnim.dmg, battleAnim.x + 50, battleAnim.y + 50);
                }

                ctx.fillStyle = playerTurn ? '#0f0' : '#f00';
                ctx.fillText(playerTurn ? 'Your Turn - × Attack' : 'Enemy Turn',300,550);
            } else if (state === STATES.POSTGAME) {
                ctx.fillStyle = '#ffd700';
                ctx.font = '40px Courier New';
                ctx.textAlign = 'center';
                ctx.fillText('Victory Through Christ!',400,300);
                ctx.font = '24px Courier New';
                ctx.fillText('All Seven Sins Defeated',400,360);
                ctx.textAlign = 'left';
            }
        }

        gameLoop();
    </script>
</body>
</html>
