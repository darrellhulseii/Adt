<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Way to Perfection - FF7 Elements RPG</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; touch-action:manipulation; }
        body { background:#000; overflow:hidden; font-family:'Courier New',monospace; color:#fff; }
        #container { position:relative; width:100vw; height:100vh; }
        canvas { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); image-rendering:pixelated; background:#000; max-width:100vw; max-height:calc(100vh - 280px); }
        #controls { position:absolute; bottom:0; left:0; width:100%; height:280px; pointer-events:none; z-index:10; }
        .btn { position:absolute; background:rgba(255,255,255,0.15); border:3px solid rgba(255,255,255,0.4); border-radius:50%; pointer-events:all; user-select:none; transition:all 0.1s; }
        .btn:active { background:rgba(255,255,255,0.5); transform:scale(0.95); }
        .dpad { width:160px; height:160px; }
        .dpad div { position:absolute; background:rgba(0,0,0,0.5); }
        .dpad .up    { top:0; left:50px; width:60px; height:50px; border-radius:25px 25px 10px 10px; }
        .dpad .down  { bottom:0; left:50px; width:60px; height:50px; border-radius:10px 10px 25px 25px; }
        .dpad .left  { left:0; top:50px; width:50px; height:60px; border-radius:25px 10px 10px 25px; }
        .dpad .right { right:0; top:50px; width:50px; height:60px; border-radius:10px 25px 25px 10px; }
        .face { width:100px; height:100px; font-size:55px; line-height:100px; text-align:center; font-weight:bold; text-shadow:2px 2px 4px #000; }
        .shoulder { width:140px; height:70px; border-radius:35px; background:rgba(200,200,200,0.3); font-size:24px; line-height:70px; text-align:center; }
        .startselect { width:80px; height:45px; border-radius:25px; background:rgba(255,100,100,0.4); font-size:16px; line-height:45px; text-align:center; }
        #pause-btn { position:absolute; top:10px; left:10px; padding:10px 15px; background:#0056a0; color:#fff; border:none; border-radius:8px; font-size:14px; z-index:20; pointer-events:all; }
    </style>
</head>
<body>
    <div id="container">
        <canvas id="canvas" width="240" height="160"></canvas>
        <button id="pause-btn" onclick="togglePause()">⏸️ Menu</button>

        <div id="controls">
            <!-- D-Pad -->
            <div class="dpad btn" style="left:40px; bottom:70px;">
                <div class="up" id="up"></div>
                <div class="down" id="down"></div>
                <div class="left" id="left"></div>
                <div class="right" id="right"></div>
            </div>

            <!-- Face Buttons -->
            <div class="face btn" style="right:140px; bottom:160px;" id="triangle">△</div>
            <div class="face btn" style="right:70px;  bottom:230px;" id="circle">○</div>
            <div class="face btn" style="right:140px; bottom:300px;" id="cross">×</div>
            <div class="face btn" style="right:210px; bottom:230px;" id="square">□</div>

            <!-- Shoulders -->
            <div class="shoulder btn" style="left:100px; top:20px;" id="l1">L1</div>
            <div class="shoulder btn" style="left:250px; top:20px;" id="l2">L2</div>
            <div class="shoulder btn" style="right:250px; top:20px;" id="r1">R1</div>
            <div class="shoulder btn" style="right:100px; top:20px;" id="r2">R2</div>

            <!-- Start / Select -->
            <div class="startselect btn" style="left:50%; margin-left:-120px; bottom:40px;" id="select">Select</div>
            <div class="startselect btn" style="left:50%; margin-left:40px; bottom:40px;" id="start">Start</div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        ctx.imageSmoothingEnabled = false;

        const TILE_SIZE = 16;
        const WORLD_W = 128, WORLD_H = 128;

        // Intro with CCC quotes
        const introPages = [
            `CCC §1849-1850: "Sin is an offense against reason, truth, and right conscience; it is failure in genuine love for God and neighbor..."`,
            `CCC §1855: "Mortal sin destroys charity in the heart of man by a grave violation of God's law..."`,
            `Genesis 3: The Fall introduced sin through envy of the devil. Revelation 21: New heaven and earth, no death or pain.`,
            `Quest: Conquer 7 Sins in towns, gain Virtues. Final: Sephiroth (Pride).`
        ];
        let introPage = 0;

        // Towns with sins, virtues, saints
        const towns = [
            {name:'Envyville', sin:'Envy', virtue:'Kindness', saint:'St. Philip Neri', npcs:['Superman','Batman','Wonder Woman'], boss:{name:'Legion', hp:400, atk:30, def:15, spd:12}},
            {name:'Greedtown', sin:'Greed', virtue:'Charity', saint:'St. Francis of Assisi', npcs:['Spider-Man','Iron Man','Captain America'], boss:{name:'Spoil', hp:500, atk:35, def:18, spd:14}},
            {name:'Sloth City', sin:'Sloth', virtue:'Diligence', saint:'St. Joseph', npcs:['Optimus Prime','Megatron','Bumblebee'], boss:{name:'Decepticon', hp:600, atk:40, def:22, spd:16}},
            {name:'Gluttonburg', sin:'Gluttony', virtue:'Temperance', saint:'St. Thomas Aquinas', npcs:['Sonic','Tails','Knuckles'], boss:{name:'Veterinarian', hp:700, atk:45, def:25, spd:13}},
            {name:'Lusthaven', sin:'Lust', virtue:'Chastity', saint:'St. Vincent Ferrer', npcs:['Pinhead','Chatterer'], boss:{name:'Cravings', hp:800, atk:50, def:28, spd:18}},
            {name:'Wrath', sin:'Wrath', virtue:'Patience', saint:'St. Stephen', npcs:['Edward Elric','Roy Mustang','Scar'], boss:{name:'Wrath', hp:900, atk:55, def:32, spd:20}},
            {name:'PrideTown', sin:'Pride', virtue:'Humility', saint:'St. John the Baptist', npcs:['Sephiroth illusion'], boss:{name:'Sephiroth', hp:1500, atk:70, def:40, spd:25, quote:'I will destroy this world and remake it perfect.'}}
        ];

        const townPos = [[10,5],[20,15],[30,25],[40,35],[50,45],[15,40],[45,10]];

        let map = Array.from({length:WORLD_H},()=>Array(WORLD_W).fill(0));
        function genMap() {
            for(let y=0;y<WORLD_H;y++) for(let x=0;x<WORLD_W;x++) {
                let base = y<15?3:y<30?4:0;
                map[y][x] = base;
                if(Math.random()<0.08) map[y][x]=1;
                if(Math.random()<0.05 + y/200) map[y][x]=2;
            }
            townPos.forEach((p,i)=>map[p[1]][p[0]]=6);
        }
        genMap();

        let player = {x:30,y:30,px:30*TILE_SIZE,py:30*TILE_SIZE,moving:false};

        const STATES = {INTRO:0,OVERWORLD:1,TOWN:2,SHOP:3,CHURCH:4,CONFESSION:5,BATTLE:6,MENU:7,DIALOG:8,POSTGAME:9,CREDITS:10};
        let state = STATES.INTRO;
        let curTown = 0, selected = 0, confessionStep = 0, creditLine = 0;

        // Party with FFVII elements (Materia specials, Limit Breaks)
        const partyBase = [
            {name:'Cloud', hp:200, mhp:200, mp:80, atk:40, def:30, spd:15, limit:0, maxLimit:100, materia:['Fire','Cure']},
            {name:'Sora', hp:180, mhp:180, mp:100, atk:35, def:25, spd:20, limit:0, maxLimit:100, materia:['Bolt','Heal']},
            {name:'Terra', hp:170, mhp:170, mp:120, atk:32, def:35, spd:16, limit:0, maxLimit:100, materia:['Ice','Restore']}
        ];
        let party = JSON.parse(JSON.stringify(partyBase));
        let active = [0,1,2];

        let virtues = 0;

        // Battle animation
        let battleAnim = {type:'', timer:0, dmg:0, x:0, y:0};

        // ATB
        let atb = [0,0,0,0]; // Party + enemy

        // Input
        const input = {
            up:false,down:false,left:false,right:false,
            cross:false,circle:false,square:false,triangle:false,
            l1:false,l2:false,r1:false,r2:false,
            start:false,select:false
        };

        function hold(btn) { input[btn] = true; }
        function release(btn) { input[btn] = false; }

        document.querySelectorAll('#up,#down,#left,#right,#cross,#circle,#square,#triangle,#l1,#l2,#r1,#r2,#start,#select').forEach(el => {
            el.addEventListener('touchstart', e => { e.preventDefault(); hold(el.id); });
            el.addEventListener('touchend', () => release(el.id));
            el.addEventListener('mousedown', () => hold(el.id));
            el.addEventListener('mouseup', () => release(el.id));
            el.addEventListener('mouseleave', () => release(el.id));
        });

        function togglePause() { paused = !paused; state = paused ? STATES.PAUSE : (state === STATES.PAUSE ? STATES.OVERWORLD : state); }

        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        function update() {
            if (state === STATES.INTRO && input.cross) {
                introPage++;
                if (introPage >= introPages.length) state = STATES.OVERWORLD;
            }

            if (state === STATES.OVERWORLD) {
                if (player.moving) return;
                let dx=0, dy=0;
                if (input.left) dx=-1;
                if (input.right) dx=1;
                if (input.up) dy=-1;
                if (input.down) dy=1;
                if (dx||dy) movePlayer(dx,dy);
                if (input.triangle) state = STATES.MENU;
            }

            if (state === STATES.TOWN) {
                if (input.cross) {
                    if (Math.random()<0.5) state = STATES.CHURCH;
                    else startBattle(towns[curTown].boss);
                }
                if (input.circle) state = STATES.OVERWORLD;
            }

            if (state === STATES.CHURCH) {
                if (input.cross) state = STATES.CONFESSION;
                if (input.circle) state = STATES.TOWN;
            }

            if (state === STATES.CONFESSION) {
                if (input.cross) {
                    confessionStep++;
                    if (confessionStep >= confessionSteps.length) {
                        state = STATES.DIALOG;
                        currentDialog = 'Absolution granted. Go in peace.';
                        confessionStep = 0;
                    }
                }
            }

            if (state === STATES.BATTLE) updateBattle();

            if (state === STATES.CREDITS && input.cross) {
                creditLine++;
                if (creditLine >= credits.length) state = STATES.OVERWORLD; // Loop back or end
            }
        }

        function movePlayer(dx,dy) {
            let nx = player.x + dx, ny = player.y + dy;
            if (nx<0||nx>=WORLD_W||ny<0||ny>=WORLD_H||map[ny][nx]===1) return;
            player.moving = true;
            let tx = nx*TILE_SIZE, ty = ny*TILE_SIZE;
            let step = 6;
            let int = setInterval(() => {
                player.px += dx*step;
                player.py += dy*step;
                if (Math.abs(tx-player.px)<step && Math.abs(ty-player.py)<step) {
                    player.px = tx; player.py = ty;
                    player.x = nx; player.y = ny;
                    player.moving = false;
                    clearInterval(int);
                    if (map[ny][nx]===2 && Math.random()<0.4) startBattle({name:'Enemy',hp:200,atk:25,def:10,spd:10});
                    let tid = townPos.findIndex(p=>p[0]===nx&&p[1]===ny);
                    if (tid!==-1) { curTown=tid; state=STATES.TOWN; }
                }
            },16);
        }

        let enemies = [], activeChar = -1, selectedCommand = 0, subSelected = 0;
        function startBattle(boss) {
            state = STATES.BATTLE;
            enemies = [{...boss, curHp:boss.hp}];
            atb = [0,0,0,0];
            activeChar = -1;
            battleAnim = {type:'', timer:0};
            for (let i = 0; i < 3; i++) party[active[i]].limit = 0;
        }

        function updateBattle() {
            if (battleAnim.timer > 0) { battleAnim.timer--; return; }

            // ATB & Limit fill
            active.forEach((pIdx, i) => {
                let p = party[pIdx];
                if (p.hp > 0) {
                    atb[i] = Math.min(100, atb[i] + p.spd / 5);
                    p.limit = Math.min(p.maxLimit, p.limit + 5); // FFVII Limit build
                }
            });
            enemies.forEach((e, i) => {
                if (e.hp > 0) atb[3 + i] = Math.min(100, atb[3 + i] + e.spd / 6);
            });

            // Player ready
            if (activeChar === -1) {
                for (let i = 0; i < 3; i++) {
                    if (atb[i] >= 100 && party[active[i]].hp > 0) {
                        activeChar = i;
                        selectedCommand = 0;
                        subSelected = 0;
                        break;
                    }
                }
            }

            // Player input (FFVII command menu)
            if (activeChar >= 0) {
                if (input.up) selectedCommand = (selectedCommand + 3) % 4;
                if (input.down) selectedCommand = (selectedCommand + 1) % 4;
                if (input.left || input.right) subSelected = (subSelected + 1) % party[active[activeChar]].materia.length;
                if (input.cross) {
                    let p = party[active[activeChar]];
                    let tgt = enemies.findIndex(e => e.curHp > 0);
                    let dmg = Math.max(1, p.atk - enemies[tgt].def / 2);
                    if (selectedCommand === 1 && p.mp >= 20) { // Magic - Materia
                        dmg *= 1.5; p.mp -= 20;
                    } else if (selectedCommand === 3 && p.limit >= p.maxLimit) { // Limit Break FFVII style
                        dmg *= 3; p.limit = 0;
                    }
                    enemies[tgt].curHp -= dmg;
                    battleAnim = {type:'slash', timer:40, dmg:dmg, x:500, y:200};
                    atb[activeChar] = 0;
                    activeChar = -1;
                }
                if (input.circle) {
                    atb[activeChar] = 99; // Cancel
                    activeChar = -1;
                }
            }

            // Enemy turn
            for (let i = 3; i < atb.length; i++) {
                if (atb[i] >= 100 && enemies[i-3].curHp > 0) {
                    let tgt = active.findIndex(pIdx => party[pIdx].hp > 0);
                    let dmg = Math.max(1, enemies[i-3].atk - party[active[tgt]].def / 2);
                    party[active[tgt]].hp -= dmg;
                    battleAnim = {type:'hit', timer:40, dmg:dmg, x:100, y:300};
                    atb[i] = 0;
                }
            }

            if (enemies.every(e => e.curHp <= 0)) {
                virtues++;
                state = virtues===7 ? STATES.POSTGAME : STATES.TOWN;
            }
        }

        let currentDialog = '';
        const confessionSteps = [
            "Bless me, Father, for I have sinned.",
            "CCC §1451: Contrition is sorrow of the soul and detestation for the sin committed...",
            "I am sorry for these and all my sins.",
            "Priest: Your penance is to defeat the sin of this town.",
            "Act of Contrition: O my God, I am heartily sorry...",
            "Priest: I absolve you... Amen. (CCC §1468)"
        ];

        const credits = [
            "Victory! Sephiroth defeated.",
            "Jesus: 'You have overcome sin through repentance.'",
            "The Saints speak:",
            towns[0].saint + ": " + towns[0].quote,
            towns[1].saint + ": " + towns[1].quote,
            towns[2].saint + ": " + towns[2].quote,
            towns[3].saint + ": " + towns[3].quote,
            towns[4].saint + ": " + towns[4].quote,
            towns[5].saint + ": " + towns[5].quote,
            towns[6].saint + ": " + towns[6].quote,
            "All the Saints are in heaven thanks to Jesus...",
            "We use what other minds have made up to make them subject to Jesus Christ through this game.",
            "God bless you! Thank you for playing!"
        ];

        function draw() {
            ctx.fillStyle = '#000'; ctx.fillRect(0,0,240,160);

            if (state === STATES.INTRO) {
                ctx.fillStyle = '#fff';
                ctx.font = '12px Courier New';
                let lines = introPages[introPage].split('\n');
                lines.forEach((l,i) => ctx.fillText(l,20,20 + i*15));
                ctx.fillText('A Confirm',20,140);
            } else if ([STATES.OVERWORLD,STATES.TOWN].includes(state)) {
                let camX = player.px - 120, camY = player.py - 80;
                for(let y=0;y<11;y++) for(let x=0;x<15;x++) {
                    let tx = Math.floor((camX + x*TILE_SIZE)/TILE_SIZE);
                    let ty = Math.floor((camY + y*TILE_SIZE)/TILE_SIZE);
                    if(tx<0||tx>=WORLD_W||ty<0||ty>=WORLD_H) ctx.fillStyle='#111';
                    else {
                        let t = map[ty][tx];
                        ctx.fillStyle = t===0?'#228B22':t===1?'#006400':t===2?'#8B4513':t===3?'#F0F8FF':t===4?'#808080':t===6?'#FFD700':'#444';
                    }
                    ctx.fillRect(x*TILE_SIZE,y*TILE_SIZE,TILE_SIZE,TILE_SIZE);
                }
                // Player sprite
                ctx.fillStyle = '#00BFFF';
                ctx.fillRect(player.px-camX+5,player.py-camY+2,6,12);
            } else if (state === STATES.BATTLE) {
                // FFVII battle background
                ctx.fillStyle = '#00008b';
                ctx.fillRect(0,0,240,160);
                // Enemies
                ctx.fillStyle = '#f00';
                ctx.fillRect(160,40,60,80);
                // Party
                ctx.fillStyle = '#00f';
                ctx.fillRect(20,80,60,60);
                // ATB bars
                atb.forEach((val, i) => {
                    ctx.fillStyle = '#0f0';
                    ctx.fillRect(10 + i*50,140,val,10);
                });
                // Command menu if ready
                if (activeChar >= 0) {
                    ctx.fillStyle = 'rgba(0,0,0,0.8)';
                    ctx.fillRect(10,10,220,120);
                    ctx.fillStyle = '#fff';
                    ctx.font = '12px Courier New';
                    commands.forEach((cmd, j) => {
                        ctx.fillStyle = j === selectedCommand ? '#ff0' : '#fff';
                        ctx.fillText(cmd,20,30 + j*20);
                    });
                }
            }
        }

        gameLoop();
    </script>
</body>
</html>
